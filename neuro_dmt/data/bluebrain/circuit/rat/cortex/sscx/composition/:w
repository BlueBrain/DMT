"""Data for the circuit composition of Rat Somatosensory cortex."""
import os
from abc import abstractmethod
import numpy as np
from dmt.vtk.phenomenon import Phenomenon
from dmt.vtk.utils.collections import Record
from dmt.vtk.measurement.parameter.group import ParameterGroup
from neuro_dmt.measurement.parameter import CorticalLayer
from neuro_dmt.data.bluebrain.circuit.cortex.sscx.composition\
    import SomatosensoryCortexCompositionData
from neuro_dmt.data.bluebrain.circuit.cortex.sscx.composition\
    import SomatosensoryCortexCompositionData


class RatSomatosensoryCortexCompositionData(
        SomatosensoryCortexCompositionData):
    """..."""

    def __init__(self, phenomenon, *args, **kwargs):
        """..."""
        self.phenomenon = phenomenon
        data = os.path.join(
            "/gpfs/bbp.cscs.ch/home/sood",
            "work/validations/dmt",
            "examples/datasets/cortex/sscx/rat",
            self.phenomenon.label)
        super().__init__(
            data=data,
            animal="rat",
            spatial_parameters={CorticalLayer()},
            *args, **kwargs)

    def with_metadata(self, reference_dataset, reference_dataframe):
        """..."""
        return Record(
            label = reference_dataset.get('short_name', 'unknown'),
            region_label = ParameterGroup(self.spatial_parameters).label,
            uri = reference_dataset.get('url', 'unknown'),
            citation = reference_dataset.get('citation', 'unknown'),
            what = reference_dataset.get('what', 'dunno'),
            data=reference_dataframe)

    @classmethod
    def summarized(self, means, stdevs, scale_factor=1.0):
        """..."""
        means = np.array(means)
        stdevs = np.array(stdevs)
        label = ParameterGroup(self.spatial_parameters).label
        return pd.DataFrame(
            {label:  range(1, 7),
             'mean': scale_factor * means,
             'std': scale_factor * stdevs})\
                 .set_index(label)
                     
    @property
    def data_location(self):
        """..."""
        return os.path.join(
            "/gpfs/bbp.cscs.ch/home/sood",
            "work/validations/dmt",
            "examples/datasets/cortex/sscx/rat",
            self.phenomenon.label)

    @classmethod
    def get(cls, phenomenon, location=None):
        """Get reference data by phenomenon.

        Parameters
        --------------------------------------------------------------------
        phenomenon :: Either[str, Phenomenon]"""

        from neuro_dmt.data.bluebrain.circuit.rat.\
            cortex.sscx.composition.cell_density\
            import RatSomatosensoryCortexCellDensityData
        from neuro_dmt.data.bluebrain.circuit.rat.\
            cortex.sscx.composition.cell_ratio\
            import RatSomatosensoryCortexCellRatioData
        from neuro_dmt.data.bluebrain.circuit.rat.\
            cortex.sscx.composition.inhibitory_synapse_density\
            import  RatSomatosensoryCortexInhibitorySynapseDensityData
        from neuro_dmt.data.bluebrain.circuit.rat.\
            cortex.sscx.composition.synapse_density\
            import RatSomatosensoryCortexSynapseDensityData

        plabel = (phenomenon.label if isinstance(phenomenon, Phenomenon) 
                  else phenomenon)

        if plabel == "cell_density":
            return RatSomatosensoryCortexCellDensityData()
        if plabel == "cell_ratio":
            return RatSomatosensoryCortexCellRatioData()
        if plabel == "inhibitory_synapse_density":
            return RatSomatosensoryCortexInhibitorySynapseDensityData()
        if plabel == "synapse_density":
            return RatSomatosensoryCortexSynapseDensityData()

        raise NotImplementedError("Data for phenomenon {}".format(phenomenon))

    
